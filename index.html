<!DOCTYPE html>
<!-- 3.0 -->
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/svg+xml" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEMAAABDCAMAAADwFEhBAAAAAXNSR0IB2cksfwAAAAlwSFlzAAAOxAAADsQBlSsOGwAAAMNQTFRF////////AAAA////////////////////2traq6urqqqq29vb////////tra2BgYGAAAAAAAABwcHu7u7////TExMAAAAAAAAAAAAaWlp////REREZmZmPz8/VVVVu7u7////fX19qqqqZmZmmZmZd3d3iIiI9vb27u7u+Pj4/v7+ERERkJCQgICAiYmJIiIimJiYMzMzAAAAb29v////AAAAAAAADg4O0dHR////29vbrKys5eXl////////////////qYDyEQAAAEF0Uk5TjlUADx8vCSZRdINPJAdfpsnZo1xBl+z/6pVAqqr////////////////////////////jjjjYyJ1VHVFySGR0g3JhKh49AAABA0lEQVR4nO3YTwuCMBQA8D1R0wqDvNW1LxBd+/hdutSnKDpWVv4pWTOmRZPca0aCezAZOH9uc8pzQIAoBgUojJdq9XWUlhgmoAwD4CwYVgdpxBfBGGKIx8B3gkFHNwTB+r3Jb/lm2HJdockHw5E0Im1o449GHWsdEY03unLzASf152IGbTKsIyGDhDcIWXF53T4Q4l1bZ1SHNtpsdNgBQt7AYSXidZflcTSWMoR16vPMS2WtN8HoZae40WfzYQR4ozS0oY0ajaa8L18aXvYN2qsZ1aENhCGZr/vb3+XJyH/1McBKMFB7BpNsk2IpGCbM1vIdmUKaE8x47sPMEYOBdFHU6R0/upyUkJQ0iwAAAABJRU5ErkJggg==">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œæ”¿ç¨‹åºè¨ˆç®—</title>
    
    <style>
        body { background-color: #f1f5f9; font-family: system-ui, -apple-system, sans-serif; }
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .tab-active { color: #1e40af; border-bottom: 2px solid #1e40af; }
        .btn-active { background-color: #1e40af !important; color: white !important; }
        input[type="date"], select { -webkit-appearance: none; }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-md mx-auto">
        <div class="card overflow-hidden border border-slate-200">
            <div class="flex border-b border-slate-100 bg-slate-50/50 relative">
                <button onclick="switchMode('calc')" id="tab-calc" class="flex-1 py-4 text-sm font-bold text-slate-400 transition-all tab-active">ğŸ—“ï¸ åˆæ³•æœŸé–“è¨ˆç®—</button>
                <button onclick="switchMode('penalty')" id="tab-penalty" class="flex-1 py-4 text-sm font-bold text-slate-400 transition-all">âš ï¸ è£ç½°æœŸé–“è¨ˆç®—</button>
            </div>

            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <span id="loading-status" class="text-xs font-bold text-slate-400">è¼‰å…¥å‡æ—¥è³‡æ–™ä¸­...</span>
                    <div class="flex bg-slate-100 p-1 rounded-lg">
                        <button onclick="setYearMode('CE')" id="btn-ce" class="px-3 py-1 rounded text-xs font-bold bg-white shadow-sm text-slate-700 transition-all">è¥¿å…ƒ</button>
                        <button onclick="setYearMode('ROC')" id="btn-roc" class="px-3 py-1 rounded text-xs font-bold text-slate-400 transition-all">æ°‘åœ‹</button>
                    </div>
                </div>

                <div id="type-selector" class="mb-6">
                    <label class="block text-xs font-black text-slate-400 mb-2 uppercase tracking-wider">æ¡ˆä»¶æ€§è³ª</label>
                    <div class="flex bg-slate-100 p-1 rounded-xl">
                        <button onclick="setType('normal')" id="btn-normal" class="btn-active flex-1 py-2 rounded-lg text-sm font-bold transition-all">ä¸€èˆ¬æ¡ˆä»¶</button>
                        <button onclick="setType('adverse')" id="btn-adverse" class="flex-1 py-2 rounded-lg text-sm font-bold text-slate-500 transition-all">ä¸åˆ©è™•åˆ†</button>
                    </div>
                    <p id="type-desc" class="text-[10px] text-slate-400 mt-2 italic">â€» ä¸€èˆ¬æ¡ˆä»¶ï¼šæœ«æ—¥é‡å‡æ—¥é †å»¶ã€‚</p>
                    <p class="text-[10px] text-slate-400 mt-1 italic">â€» åœ‹å®šå‡æ—¥ï¼ˆ2018~2026) å…¶é¤˜è¨ˆç®—å…­æ—¥ã€‚</p>
                </div>

                <hr id="divider" class="mb-6 border-slate-100">

                <div id="section-calc" class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">å…¥å¢ƒæ—¥</label>
                        <input type="date" id="startDate" class="auto-calc w-full p-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-blue-500">
                        <div id="startDate_roc_group" class="hidden flex items-center border border-slate-200 rounded-xl bg-white overflow-hidden w-full focus-within:ring-2 focus-within:ring-blue-500">
                            <span class="pl-3 text-slate-400 text-sm font-bold whitespace-nowrap">æ°‘åœ‹</span>
                            <input type="number" id="startDate_roc_y" class="auto-calc-roc w-full p-3 outline-none text-center" placeholder="å¹´">
                            <span class="text-slate-200">/</span>
                            <input type="number" id="startDate_roc_m" class="auto-calc-roc w-full p-3 outline-none text-center" placeholder="æœˆ">
                            <span class="text-slate-200">/</span>
                            <input type="number" id="startDate_roc_d" class="auto-calc-roc w-full p-3 outline-none text-center" placeholder="æ—¥">
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <div class="flex-[2]">
                            <label class="block text-xs font-bold text-slate-500 mb-1">æœŸé–“</label>
                            <input type="number" id="periodValue" value="30" class="auto-calc w-full p-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-500 mb-1">å–®ä½</label>
                            <select id="periodUnit" class="auto-calc w-full p-3 rounded-xl border border-slate-200 bg-white outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="day">æ—¥</option>
                                <option value="month">æœˆ</option>
                                <option value="year">å¹´</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="section-penalty" class="space-y-5 hidden">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">è£ç½°èµ·ç®—æ—¥</label>
                        <input type="date" id="date-start" class="auto-penalty w-full p-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-blue-500">
                        <div id="date-start_roc_group" class="hidden flex items-center border border-slate-200 rounded-xl bg-white overflow-hidden w-full focus-within:ring-2 focus-within:ring-blue-500">
                            <span class="pl-3 text-slate-400 text-sm font-bold whitespace-nowrap">æ°‘åœ‹</span>
                            <input type="number" id="date-start_roc_y" class="auto-penalty-roc w-full p-3 outline-none text-center" placeholder="å¹´">
                            <span class="text-slate-200">/</span>
                            <input type="number" id="date-start_roc_m" class="auto-penalty-roc w-full p-3 outline-none text-center" placeholder="æœˆ">
                            <span class="text-slate-200">/</span>
                            <input type="number" id="date-start_roc_d" class="auto-penalty-roc w-full p-3 outline-none text-center" placeholder="æ—¥">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">å—ç†è£ç½°æ—¥</label>
                        <input type="date" id="date-end" class="auto-penalty w-full p-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-blue-500">
                        <div id="date-end_roc_group" class="hidden flex items-center border border-slate-200 rounded-xl bg-white overflow-hidden w-full focus-within:ring-2 focus-within:ring-blue-500">
                            <span class="pl-3 text-slate-400 text-sm font-bold whitespace-nowrap">æ°‘åœ‹</span>
                            <input type="number" id="date-end_roc_y" class="auto-penalty-roc w-full p-3 outline-none text-center" placeholder="å¹´">
                            <span class="text-slate-200">/</span>
                            <input type="number" id="date-end_roc_m" class="auto-penalty-roc w-full p-3 outline-none text-center" placeholder="æœˆ">
                            <span class="text-slate-200">/</span>
                            <input type="number" id="date-end_roc_d" class="auto-penalty-roc w-full p-3 outline-none text-center" placeholder="æ—¥">
                        </div>
                    </div>
                </div>

                <div id="result-area" class="mt-8 hidden border-t border-dashed pt-6">
                    <div id="status-card" class="p-5 rounded-2xl transition-all">
                        <div id="res-title" class="text-[10px] font-black uppercase tracking-widest mb-1"></div>
                        <div id="res-main" class="text-3xl font-black"></div>
                        <div id="res-sub" class="text-sm font-bold mt-1"></div>
                        <div id="res-total-days" class="text-xs font-bold mt-2 text-slate-600"></div>
                        <div id="res-detail" class="text-xs mt-3 leading-relaxed opacity-80 whitespace-pre-wrap"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ”¹ç‚ºç©ºç‰©ä»¶ï¼Œç­‰å¾… fetch è¼‰å…¥
        let HOLIDAY_DATA = {};
        
        let currentType = 'normal', currentMode = 'calc', yearMode = 'CE';
        const weekNames = ["æ˜ŸæœŸæ—¥", "æ˜ŸæœŸä¸€", "æ˜ŸæœŸäºŒ", "æ˜ŸæœŸä¸‰", "æ˜ŸæœŸå››", "æ˜ŸæœŸäº”", "æ˜ŸæœŸå…­"];
        const dateFieldIDs = ['startDate', 'date-start', 'date-end'];

        // éåŒæ­¥è¼‰å…¥ holiday.json
        async function loadHolidayData() {
            const statusLabel = document.getElementById('loading-status');
            try {
                const response = await fetch('holiday.json');
                if (!response.ok) throw new Error('Network response was not ok');
                HOLIDAY_DATA = await response.json();
                statusLabel.innerText = "å‡æ—¥è³‡æ–™å·²æ›´æ–°";
                statusLabel.classList.replace('text-slate-400', 'text-emerald-500');
                
                // 3ç§’å¾Œéš±è—ç‹€æ…‹æç¤º
                setTimeout(() => {
                    statusLabel.style.opacity = '0';
                    statusLabel.style.transition = 'opacity 0.5s';
                }, 3000);
            } catch (error) {
                console.error("ç„¡æ³•è¼‰å…¥ holiday.jsonï¼Œå°‡é€€å›åƒ…åˆ¤æ–·å…­æ—¥:", error);
                statusLabel.innerText = "æœ¬åœ°æ¸¬è©¦æ¨¡å¼ (åƒ…åˆ¤æ–·é€±æœ«)";
                statusLabel.classList.replace('text-slate-400', 'text-amber-500');
            }
        }

        function setYearMode(mode) {
            yearMode = mode;
            document.getElementById('btn-ce').className = mode === 'CE' ? 'px-3 py-1 rounded text-xs font-bold bg-white shadow-sm text-slate-700 transition-all' : 'px-3 py-1 rounded text-xs font-bold text-slate-400 transition-all';
            document.getElementById('btn-roc').className = mode === 'ROC' ? 'px-3 py-1 rounded text-xs font-bold bg-white shadow-sm text-slate-700 transition-all' : 'px-3 py-1 rounded text-xs font-bold text-slate-400 transition-all';
            
            dateFieldIDs.forEach(id => {
                document.getElementById(id).classList.toggle('hidden', mode === 'ROC');
                document.getElementById(id + '_roc_group').classList.toggle('hidden', mode === 'CE');
                syncDate(id, mode === 'CE' ? 'ROC' : 'CE');
            });
            triggerCalc();
        }

        function syncDate(id, source) {
            if (source === 'CE') {
                const ceVal = document.getElementById(id).value;
                if (ceVal) {
                    const [y, m, d] = ceVal.split('-');
                    document.getElementById(id + '_roc_y').value = parseInt(y) - 1911;
                    document.getElementById(id + '_roc_m').value = parseInt(m);
                    document.getElementById(id + '_roc_d').value = parseInt(d);
                }
            } else {
                const y = parseInt(document.getElementById(id + '_roc_y').value);
                const m = parseInt(document.getElementById(id + '_roc_m').value);
                const d = parseInt(document.getElementById(id + '_roc_d').value);
                if (y && m && d) {
                    const ceY = y + 1911;
                    const ceM = ('0' + m).slice(-2);
                    const ceD = ('0' + d).slice(-2);
                    document.getElementById(id).value = `${ceY}-${ceM}-${ceD}`;
                }
            }
        }

        function triggerCalc() {
            if (currentMode === 'calc') runCalc(); else runPenalty();
        }

        function switchMode(m) {
            currentMode = m;
            document.getElementById('section-calc').classList.toggle('hidden', m !== 'calc');
            document.getElementById('section-penalty').classList.toggle('hidden', m !== 'penalty');
            document.getElementById('type-selector').classList.toggle('hidden', m !== 'calc');
            document.getElementById('divider').classList.toggle('hidden', m !== 'calc');

            document.getElementById('tab-calc').className = m === 'calc' ? 'flex-1 py-4 text-sm font-bold tab-active' : 'flex-1 py-4 text-sm font-bold text-slate-400';
            document.getElementById('tab-penalty').className = m === 'penalty' ? 'flex-1 py-4 text-sm font-bold tab-active' : 'flex-1 py-4 text-sm font-bold text-slate-400';
            triggerCalc();
        }

        function setType(t) {
            currentType = t;
            document.getElementById('btn-normal').className = t === 'normal' ? 'btn-active flex-1 py-2 rounded-lg text-sm font-bold transition-all' : 'flex-1 py-2 rounded-lg text-sm font-bold text-slate-500';
            document.getElementById('btn-adverse').className = t === 'adverse' ? 'btn-active flex-1 py-2 rounded-lg text-sm font-bold transition-all' : 'flex-1 py-2 rounded-lg text-sm font-bold text-slate-500';
            document.getElementById('type-desc').innerText = t === 'normal' ? "â€» ä¸€èˆ¬æ¡ˆä»¶ï¼šæœ«æ—¥é‡å‡æ—¥é †å»¶ã€‚" : "â€» ä¸åˆ©è™•åˆ†ï¼šå§‹æ—¥è¨ˆ 1 æ—¥ä¸”ä¸é †å»¶ã€‚";
            runCalc();
        }

        function isHoliday(date) {
            const y = date.getFullYear(), m = date.getMonth(), d = date.getDate();
            if (HOLIDAY_DATA[y]) return HOLIDAY_DATA[y][m].charAt(d - 1) === "1";
            return (date.getDay() === 0 || date.getDay() === 6);
        }

        function getLocalDateStr(date) {
            let y = date.getFullYear();
            let m = ('0' + (date.getMonth() + 1)).slice(-2);
            let d = ('0' + date.getDate()).slice(-2);
            if (yearMode === 'ROC') return `æ°‘åœ‹ ${y - 1911} å¹´ ${m} æœˆ ${d} æ—¥`;
            return `${y}-${m}-${d}`;
        }

        function runCalc() {
            const s = document.getElementById('startDate').value;
            if (!s) return;
            const p = parseInt(document.getElementById('periodValue').value), u = document.getElementById('periodUnit').value;
            if (isNaN(p)) return;

            let parts = s.split('-');
            let start = new Date(parts[0], parts[1]-1, parts[2]);
            let end = new Date(start);

            if (currentType === 'normal') {
                if (u === 'day') end.setDate(end.getDate() + p);
                else if (u === 'month') end.setMonth(end.getMonth() + p);
                else end.setFullYear(end.getFullYear() + p);
                let skip = 0; while (isHoliday(end)) { end.setDate(end.getDate() + 1); skip++; }
                var detail = `ä¸€èˆ¬æ¡ˆä»¶ï¼šå§‹æ—¥ä¸è¨ˆã€‚` + (skip > 0 ? ` æœ«æ—¥é€¢å‡æ—¥é †å»¶ ${skip} å¤©ã€‚` : "");
            } else {
                if (u === 'day') end.setDate(end.getDate() + (p - 1));
                else { 
                    end.setMonth(end.getMonth() + (u==='month'?p:0)); 
                    end.setFullYear(end.getFullYear() + (u==='year'?p:0)); 
                    end.setDate(end.getDate() - 1); 
                }
                var detail = "ä¸åˆ©è™•åˆ†ï¼šå§‹æ—¥è¨ˆå…¥ï¼Œä¸é †å»¶ã€‚";
            }
            let actualStart = new Date(start);
            if (currentType === 'normal') actualStart.setDate(actualStart.getDate() + 1);
            
            const total = Math.round((end - actualStart)/864e5) + 1;
            showResult("å±†æ»¿æ—¥æœŸ (æœ«æ—¥)", getLocalDateStr(end), weekNames[end.getDay()], detail, "blue", `å…±è¨ˆï¼š${total} å¤©`);
        }

        function getEquivalentDate(start, addedMonths) {
            let y = start.getFullYear() + Math.floor((start.getMonth() + addedMonths) / 12);
            let m = (start.getMonth() + addedMonths) % 12;
            let d = start.getDate();
            let temp = new Date(y, m, d);
            if (temp.getMonth() !== m) temp = new Date(y, m + 1, 0); 
            return temp;
        }

        function runPenalty() {
            const v1 = document.getElementById('date-start').value;
            const v2 = document.getElementById('date-end').value;
            if (!v1 || !v2) return;

            let parts1 = v1.split('-');
            let parts2 = v2.split('-');
            let start = new Date(parts1[0], parts1[1]-1, parts1[2]);
            let end = new Date(parts2[0], parts2[1]-1, parts2[2]);

            if (start > end) return showResult("éŒ¯èª¤", "æ—¥æœŸé †åºæœ‰èª¤", "", "èµ·ç®—æ—¥ä¸å¯æ™šæ–¼å—ç†æ—¥", "rose", "");

            let totalMonths = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());
            let tempDate = getEquivalentDate(start, totalMonths);
            if (tempDate > end) { totalMonths--; tempDate = getEquivalentDate(start, totalMonths); }

            let years = Math.floor(totalMonths / 12), months = totalMonths % 12;
            let remainDays = Math.round((end - tempDate) / 864e5) + 1;

            let resStr = "";
            if (years > 0) resStr += years + "å¹´";
            if (months > 0) resStr += months + "å€‹æœˆ";
            if (remainDays > 0 || resStr === "") resStr += remainDays + "æ—¥";

            let detailHtml = "";
            if (totalMonths > 0) {
                let endOfPeriod = new Date(tempDate);
                endOfPeriod.setDate(endOfPeriod.getDate() - 1);
                detailHtml += `è¨ˆç®—æœŸé–“æ‡‰è‡ªèµ·ç®—æ—¥(${start.getMonth()+1}æœˆ${start.getDate()}æ—¥)ç›¸ç•¶æ—¥(${tempDate.getMonth()+1}æœˆ${tempDate.getDate()}æ—¥)ä¹‹å‰ä¸€æ—¥(${endOfPeriod.getMonth()+1}æœˆ${endOfPeriod.getDate()}æ—¥)ç‚ºæœŸé–“ä¹‹æœ«æ—¥ã€‚\n\n`;
                detailHtml += `å› æ­¤ï¼Œ${getLocalDateStr(start)} ï½ ${getLocalDateStr(endOfPeriod)} ç‚º${years > 0 ? years + 'å¹´' : ''}${months > 0 ? months + 'å€‹æœˆ' : ''}ã€‚\n`;
                if (remainDays > 0) detailHtml += `${getLocalDateStr(tempDate)} ï½ ${getLocalDateStr(end)} è¨ˆ ${remainDays} æ—¥ã€‚`;
            } else {
                detailHtml += `èµ·ç®—æ—¥ç‚º ${getLocalDateStr(start)}ï¼Œè‡³ ${getLocalDateStr(end)}ï¼Œä¸è¶³ 1 å€‹æœˆã€‚\nå…±è¨ˆ ${remainDays} æ—¥ã€‚`;
            }
            showResult("è¨ˆç®—çµæœ", resStr, ``, detailHtml, "emerald", "");
        }

        function showResult(t, m, s, d, color, total) {
            document.getElementById('result-area').classList.remove('hidden');
            document.getElementById('res-title').innerText = t;
            document.getElementById('res-main').innerText = m;
            document.getElementById('res-sub').innerText = s;
            document.getElementById('res-detail').innerText = d;
            
            const tBox = document.getElementById('res-total-days');
            tBox.innerText = total || ""; 
            tBox.classList.toggle('hidden', !total);
            const themes = { blue: "bg-blue-50 text-blue-700 border-blue-100", rose: "bg-rose-50 text-rose-700 border-rose-100", emerald: "bg-emerald-50 text-emerald-700 border-emerald-100" };
            document.getElementById('status-card').className = `p-5 rounded-2xl border ${themes[color]}`;
        }

        // ä½¿ç”¨ async ç¢ºä¿è³‡æ–™è¼‰å…¥å®Œæˆå¾Œæ‰åŸ·è¡Œåˆå§‹è¨ˆç®—
        window.onload = async () => {
            await loadHolidayData();

            const today = new Date().toISOString().split('T')[0];
            dateFieldIDs.forEach(id => {
                document.getElementById(id).value = today;
                syncDate(id, 'CE');
            });

            document.querySelectorAll('.auto-calc').forEach(el => el.addEventListener('input', () => {
                if(el.type === 'date') syncDate(el.id, 'CE');
                triggerCalc();
            }));
            document.querySelectorAll('.auto-calc-roc').forEach(el => el.addEventListener('input', () => {
                syncDate('startDate', 'ROC'); triggerCalc();
            }));
            document.querySelectorAll('.auto-penalty').forEach(el => el.addEventListener('input', () => {
                if(el.type === 'date') syncDate(el.id, 'CE');
                triggerCalc();
            }));
            document.querySelectorAll('.auto-penalty-roc').forEach(el => el.addEventListener('input', (e) => {
                syncDate(e.target.id.replace('_roc_y','').replace('_roc_m','').replace('_roc_d',''), 'ROC'); 
                triggerCalc();
            }));

            runCalc(); 
        };
    </script>
</body>
</html>
