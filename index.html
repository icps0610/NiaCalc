<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œæ”¿ç¨‹åºèˆ‡è£ç½°è¨ˆç®—ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .modal-enter {
            opacity: 0;
            transform: translateY(-10px);
        }
        .modal-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }
        /* å°ä¸‰é€š Loading å‹•ç•« */
        .loading-ring { border-top-color: #1e40af; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 p-4 md:p-8 font-sans min-h-screen flex justify-center items-start">
    <div class="w-full max-w-md">
        <div class="bg-white rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.06)] border border-slate-100 overflow-hidden">
            <div class="flex border-b border-slate-100 bg-slate-50/50">
                <button onclick="switchMode('calc')" id="tab-calc"
                    class="flex-1 py-3.5 text-xs sm:text-sm font-bold border-b-2 transition-all text-blue-800 border-blue-800">
                    ğŸ—“ï¸ åˆæ³•æœŸé–“
                </button>
                <button onclick="switchMode('penalty')" id="tab-penalty"
                    class="flex-1 py-3.5 text-xs sm:text-sm font-bold border-b-2 transition-all text-slate-400 border-transparent hover:text-slate-600">
                    âš ï¸ è£ç½°æœŸé–“
                </button>
                <button onclick="switchMode('matsu')" id="tab-matsu"
                    class="flex-1 py-3.5 text-xs sm:text-sm font-bold border-b-2 transition-all text-slate-400 border-transparent hover:text-slate-600">
                    ğŸš¢ å°ä¸‰é€š
                </button>
            </div>

            <div class="p-5 md:p-8">
                <div id="year-switcher-container" class="flex justify-end mb-6">
                    <div class="flex bg-slate-100/80 p-1 rounded-lg">
                        <button onclick="setYearMode('CE')" id="btn-ce"
                            class="px-4 py-1.5 rounded-md text-xs font-bold transition-all text-slate-500 hover:text-slate-700">è¥¿å…ƒ</button>
                        <button onclick="setYearMode('ROC')" id="btn-roc"
                            class="px-4 py-1.5 rounded-md text-xs font-bold transition-all bg-white shadow-sm text-slate-700">æ°‘åœ‹</button>
                    </div>
                </div>

                <div id="section-calc" class="space-y-6">
                    <div>
                        <label class="block text-xs font-black text-slate-400 mb-2 uppercase tracking-widest">æ¡ˆä»¶æ€§è³ª</label>
                        <div class="flex bg-slate-100/80 p-1 rounded-xl">
                            <button onclick="setType('normal')" id="btn-normal"
                                class="flex-1 py-2 rounded-lg text-sm font-bold transition-all bg-blue-800 text-white shadow-md">ä¸€èˆ¬æ¡ˆä»¶</button>
                            <button onclick="setType('adverse')" id="btn-adverse"
                                class="flex-1 py-2 rounded-lg text-sm font-bold transition-all text-slate-500 hover:bg-slate-200/50">ä¸åˆ©è™•åˆ†</button>
                        </div>
                        <p id="type-desc" class="text-[11px] text-slate-400 mt-2">â€» ä¸€èˆ¬æ¡ˆä»¶ï¼šæœ«æ—¥é‡å‡æ—¥é †å»¶ã€‚</p>
                        <p class="text-[11px] text-slate-400 mt-1">â€» åœ‹å®šå‡æ—¥ï¼ˆ2018~2026ï¼‰å…¶é¤˜è¨ˆç®—å…­æ—¥ã€‚</p>
                    </div>

                    <hr class="border-slate-100">

                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-2">å…¥å¢ƒæ—¥</label>
                        <input type="hidden" id="startDate" class="auto-calc">
                        <div id="startDate_ce_group" class="hidden flex items-center border border-slate-200 rounded-xl bg-white overflow-hidden w-full focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-500 transition-all">
                            <span class="pl-4 text-slate-400 text-sm font-bold whitespace-nowrap">è¥¿å…ƒ</span>
                            <input type="number" id="startDate_ce_y" class="auto-calc-ce w-full p-3 outline-none text-center font-medium" placeholder="å¹´">
                            <span class="text-slate-300">/</span>
                            <input type="number" id="startDate_ce_m" class="auto-calc-ce w-full p-3 outline-none text-center font-medium" placeholder="æœˆ">
                            <span class="text-slate-300">/</span>
                            <input type="number" id="startDate_ce_d" class="auto-calc-ce w-full p-3 outline-none text-center font-medium" placeholder="æ—¥">
                            <button onclick="openCalendar('startDate_ce')" class="px-4 py-3 text-slate-400 hover:text-blue-600 bg-slate-50 border-l border-slate-100 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </button>
                        </div>
                        <div id="startDate_roc_group" class="hidden flex items-center border border-slate-200 rounded-xl bg-white overflow-hidden w-full focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-500 transition-all">
                            <span class="pl-4 text-slate-400 text-sm font-bold whitespace-nowrap">æ°‘åœ‹</span>
                            <input type="number" id="startDate_roc_y" class="auto-calc-roc w-full p-3 outline-none text-center font-medium" placeholder="å¹´">
                            <span class="text-slate-300">/</span>
                            <input type="number" id="startDate_roc_m" class="auto-calc-roc w-full p-3 outline-none text-center font-medium" placeholder="æœˆ">
                            <span class="text-slate-300">/</span>
                            <input type="number" id="startDate_roc_d" class="auto-calc-roc w-full p-3 outline-none text-center font-medium" placeholder="æ—¥">
                            <button onclick="openCalendar('startDate_roc')" class="px-4 py-3 text-slate-400 hover:text-blue-600 bg-slate-50 border-l border-slate-100 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </button>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <div class="flex-[2]">
                            <label class="block text-xs font-bold text-slate-500 mb-2">æœŸé–“</label>
                            <input type="number" id="periodValue" value="3" class="auto-calc w-full p-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all font-medium">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-500 mb-2">å–®ä½</label>
                            <select id="periodUnit" class="auto-calc w-full p-3 rounded-xl border border-slate-200 bg-white outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all font-medium text-slate-700">
                                <option value="month">æœˆ</option>
                                <option value="day">æ—¥</option>
                                <option value="year">å¹´</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="section-penalty" class="space-y-6 hidden">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-2">è£ç½°èµ·ç®—æ—¥</label>
                        <input type="hidden" id="date-start" class="auto-penalty">
                        <div id="date-start_ce_group" class="hidden flex items-center border border-slate-200 rounded-xl bg-white overflow-hidden w-full focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-500 transition-all">
                            <span class="pl-4 text-slate-400 text-sm font-bold whitespace-nowrap">è¥¿å…ƒ</span>
                            <input type="number" id="date-start_ce_y" class="auto-penalty-ce w-full p-3 outline-none text-center font-medium" placeholder="å¹´">
                            <span class="text-slate-300">/</span>
                            <input type="number" id="date-start_ce_m" class="auto-penalty-ce w-full p-3 outline-none text-center font-medium" placeholder="æœˆ">
                            <span class="text-slate-300">/</span>
                            <input type="number" id="date-start_ce_d" class="auto-penalty-ce w-full p-3 outline-none text-center font-medium" placeholder="æ—¥">
                            <button onclick="openCalendar('date-start_ce')" class="px-4 py-3 text-slate-400 hover:text-blue-600 bg-slate-50 border-l border-slate-100 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </button>
                        </div>
                        <div id="date-start_roc_group" class="hidden flex items-center border border-slate-200 rounded-xl bg-white overflow-hidden w-full focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-500 transition-all">
                            <span class="pl-4 text-slate-400 text-sm font-bold whitespace-nowrap">æ°‘åœ‹</span>
                            <input type="number" id="date-start_roc_y" class="auto-penalty-roc w-full p-3 outline-none text-center font-medium" placeholder="å¹´">
                            <span class="text-slate-300">/</span>
                            <input type="number" id="date-start_roc_m" class="auto-penalty-roc w-full p-3 outline-none text-center font-medium" placeholder="æœˆ">
                            <span class="text-slate-300">/</span>
                            <input type="number" id="date-start_roc_d" class="auto-penalty-roc w-full p-3 outline-none text-center font-medium" placeholder="æ—¥">
                            <button onclick="openCalendar('date-start_roc')" class="px-4 py-3 text-slate-400 hover:text-blue-600 bg-slate-50 border-l border-slate-100 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-2">å—ç†è£ç½°æ—¥</label>
                        <input type="hidden" id="date-end" class="auto-penalty">
                        <div id="date-end_ce_group" class="hidden flex items-center border border-slate-200 rounded-xl bg-white overflow-hidden w-full focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-500 transition-all">
                            <span class="pl-4 text-slate-400 text-sm font-bold whitespace-nowrap">è¥¿å…ƒ</span>
                            <input type="number" id="date-end_ce_y" class="auto-penalty-ce w-full p-3 outline-none text-center font-medium" placeholder="å¹´">
                            <span class="text-slate-300">/</span>
                            <input type="number" id="date-end_ce_m" class="auto-penalty-ce w-full p-3 outline-none text-center font-medium" placeholder="æœˆ">
                            <span class="text-slate-300">/</span>
                            <input type="number" id="date-end_ce_d" class="auto-penalty-ce w-full p-3 outline-none text-center font-medium" placeholder="æ—¥">
                            <button onclick="openCalendar('date-end_ce')" class="px-4 py-3 text-slate-400 hover:text-blue-600 bg-slate-50 border-l border-slate-100 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </button>
                        </div>
                        <div id="date-end_roc_group" class="hidden flex items-center border border-slate-200 rounded-xl bg-white overflow-hidden w-full focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-500 transition-all">
                            <span class="pl-4 text-slate-400 text-sm font-bold whitespace-nowrap">æ°‘åœ‹</span>
                            <input type="number" id="date-end_roc_y" class="auto-penalty-roc w-full p-3 outline-none text-center font-medium" placeholder="å¹´">
                            <span class="text-slate-300">/</span>
                            <input type="number" id="date-end_roc_m" class="auto-penalty-roc w-full p-3 outline-none text-center font-medium" placeholder="æœˆ">
                            <span class="text-slate-300">/</span>
                            <input type="number" id="date-end_roc_d" class="auto-penalty-roc w-full p-3 outline-none text-center font-medium" placeholder="æ—¥">
                            <button onclick="openCalendar('date-end_roc')" class="px-4 py-3 text-slate-400 hover:text-blue-600 bg-slate-50 border-l border-slate-100 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="result-area" class="mt-8 hidden pt-6 border-t border-dashed border-slate-200">
                    <div id="status-card" class="p-6 rounded-2xl transition-all border">
                        <div id="res-title" class="text-xs font-black uppercase tracking-widest mb-2"></div>
                        <div id="res-main" class="text-4xl font-black mb-1"></div>
                        <div id="res-sub" class="text-sm font-bold mt-1"></div>
                        <div id="res-total-days" class="text-sm font-bold mt-2 opacity-90 hidden"></div>
                        <div id="res-detail" class="text-sm mt-4 leading-relaxed opacity-80 whitespace-pre-wrap"></div>
                    </div>
                </div>

                <div id="nation-switcher" class="hidden mt-6">
                    <div class="flex bg-slate-100/80 p-1 rounded-xl">
                        <button onclick="setPenaltyNation('china')" id="btn-china"
                            class="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all bg-blue-800 text-white shadow-md">CN ä¸­åœ‹äºº</button>
                        <button onclick="setPenaltyNation('foreign')" id="btn-foreign"
                            class="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all text-slate-500 hover:bg-slate-200/50">ğŸŒ å¤–åœ‹äºº</button>
                    </div>
                </div>

                <div id="fine-display" class="hidden mt-4 bg-amber-50 border border-amber-200 rounded-2xl p-6 shadow-sm transition-all">
                    <div class="text-xs font-black uppercase tracking-widest text-amber-600 mb-2">æ‡‰è£è™•ç½°é°</div>
                    <div id="fine-amount" class="text-3xl font-black text-amber-700 tracking-tight"></div>
                    <div id="fine-basis" class="text-sm font-semibold text-amber-600 mt-2 opacity-90"></div>
                    <div id="fine-note" class="text-[11px] text-amber-500 mt-3 italic leading-relaxed"></div>
                </div>

                <div id="section-matsu" class="hidden space-y-4">
                    <div class="flex justify-between items-end mb-2">
                        <div>
                            <h2 class="text-[11px] font-black text-slate-400 uppercase tracking-widest">ä»Šæ—¥å³æ™‚é å ±</h2>
                            <p class="text-xs text-slate-500 mt-1 font-semibold" id="matsu-updateTime">ç‹€æ…‹ï¼šåˆå§‹åŒ–ä¸­...</p>
                        </div>
                        <div id="matsu-countdown" class="text-[10px] font-mono bg-blue-50 text-blue-700 px-2.5 py-1 rounded-md border border-blue-100 shadow-sm font-bold">
                            è¼‰å…¥ä¸­...
                        </div>
                    </div>

                    <div id="matsu-resultArea" class="space-y-4 mt-2">
                        <div class="flex flex-col items-center justify-center py-16 bg-slate-50 rounded-2xl border border-dashed border-slate-200">
                            <div class="loading-ring w-10 h-10 border-4 border-slate-200 rounded-full mb-3"></div>
                            <p class="text-xs font-bold text-slate-400 animate-pulse">é€£ç·šè‡³æ¸¯å‹™ç³»çµ±ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="calendar-modal" class="hidden fixed inset-0 bg-slate-900/40 z-50 flex items-start justify-center px-4 pt-[15vh] pb-8 backdrop-blur-sm">
        <div id="calendar-card" class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden modal-enter border border-slate-100">
            <div class="flex justify-between items-center p-5 border-b border-slate-100 bg-slate-50/80">
                <button onclick="changeCalMonth(-1)" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-500 hover:bg-white hover:shadow-sm transition-all">&lt;</button>
                <div id="cal-title" class="font-bold text-slate-800 text-lg tracking-wider"></div>
                <button onclick="changeCalMonth(1)" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-500 hover:bg-white hover:shadow-sm transition-all">&gt;</button>
            </div>
            <div class="p-5">
                <div class="grid grid-cols-7 text-center text-xs font-bold text-slate-400 mb-3">
                    <div class="text-rose-400">æ—¥</div>
                    <div>ä¸€</div>
                    <div>äºŒ</div>
                    <div>ä¸‰</div>
                    <div>å››</div>
                    <div>äº”</div>
                    <div class="text-emerald-500">å…­</div>
                </div>
                <div id="cal-days" class="grid grid-cols-7 gap-y-2 gap-x-1 text-slate-700"></div>
            </div>
            <div class="p-4 border-t border-slate-100 flex justify-end bg-slate-50/80">
                <button onclick="closeCalendar()" class="px-6 py-2 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-200 transition-colors">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // ---- ç³»çµ±è®Šæ•¸ ----
        let HOLIDAY_DATA = {};
        let currentType = 'normal', currentMode = 'calc', yearMode = 'ROC';
        const weekNames = ["æ˜ŸæœŸæ—¥", "æ˜ŸæœŸä¸€", "æ˜ŸæœŸäºŒ", "æ˜ŸæœŸä¸‰", "æ˜ŸæœŸå››", "æ˜ŸæœŸäº”", "æ˜ŸæœŸå…­"];
        const dateFieldIDs = ['startDate', 'date-start', 'date-end'];

        let calTargetPrefix = '';
        let calIsROC = true;
        let calViewYear = 115;
        let calViewMonth = 1;

        // ---- æ¨£å¼å¸¸æ•¸ ----
        const TAB_ACTIVE = "flex-1 py-3.5 text-xs sm:text-sm font-bold border-b-2 transition-all text-blue-800 border-blue-800";
        const TAB_INACTIVE = "flex-1 py-3.5 text-xs sm:text-sm font-bold border-b-2 transition-all text-slate-400 border-transparent hover:text-slate-600";
        
        const BTN_ACTIVE = "flex-1 py-2.5 rounded-lg text-sm font-bold transition-all bg-blue-800 text-white shadow-md";
        const BTN_INACTIVE = "flex-1 py-2.5 rounded-lg text-sm font-bold transition-all text-slate-500 hover:bg-slate-200/50";

        const YR_ACTIVE = "px-4 py-1.5 rounded-md text-xs font-bold transition-all bg-white shadow-sm text-slate-700";
        const YR_INACTIVE = "px-4 py-1.5 rounded-md text-xs font-bold transition-all text-slate-500 hover:text-slate-700";

        // ---- UI åˆ‡æ›é‚è¼¯ ----
        function switchMode(m) {
            currentMode = m;
            
            // å€å¡Šé¡¯ç¤ºæ§åˆ¶
            document.getElementById('section-calc').classList.toggle('hidden', m !== 'calc');
            document.getElementById('section-penalty').classList.toggle('hidden', m !== 'penalty');
            document.getElementById('section-matsu').classList.toggle('hidden', m !== 'matsu');
            document.getElementById('year-switcher-container').classList.toggle('hidden', m === 'matsu');
            
            // æ¨™ç±¤æ¨£å¼æ§åˆ¶
            document.getElementById('tab-calc').className = m === 'calc' ? TAB_ACTIVE : TAB_INACTIVE;
            document.getElementById('tab-penalty').className = m === 'penalty' ? TAB_ACTIVE : TAB_INACTIVE;
            document.getElementById('tab-matsu').className = m === 'matsu' ? TAB_ACTIVE : TAB_INACTIVE;

            // è™•ç†çµæœå€é¡¯ç¤º/éš±è—èˆ‡ç‰¹å®šé‚è¼¯
            if (m === 'matsu') {
                document.getElementById('result-area').classList.add('hidden');
                document.getElementById('nation-switcher').classList.add('hidden');
                document.getElementById('fine-display').classList.add('hidden');
                
                if (!matsuInitialized) {
                    initMatsuDashboard();
                    matsuInitialized = true;
                }
            } else {
                if (m === 'calc') updateFineDisplay(0);
                triggerCalc(); // é‡æ–°è¨ˆç®—ä¸¦é¡¯ç¤ºçµæœ
            }
        }

        // ---- è¨ˆç®—æ©Ÿé‚è¼¯ ----
        function setYearMode(mode) {
            yearMode = mode;
            document.getElementById('btn-ce').className = mode === 'CE' ? YR_ACTIVE : YR_INACTIVE;
            document.getElementById('btn-roc').className = mode === 'ROC' ? YR_ACTIVE : YR_INACTIVE;

            dateFieldIDs.forEach(id => {
                document.getElementById(id + '_ce_group').classList.toggle('hidden', mode === 'ROC');
                document.getElementById(id + '_roc_group').classList.toggle('hidden', mode === 'CE');
            });
            triggerCalc();
        }

        function syncDate(id, source) {
            const yEl = document.getElementById(id + '_' + source.toLowerCase() + '_y');
            const mEl = document.getElementById(id + '_' + source.toLowerCase() + '_m');
            const dEl = document.getElementById(id + '_' + source.toLowerCase() + '_d');

            if (!yEl || !mEl || !dEl) return;

            const y = parseInt(yEl.value);
            const m = parseInt(mEl.value);
            const d = parseInt(dEl.value);

            if (isNaN(y) || isNaN(m) || isNaN(d)) {
                document.getElementById(id).value = '';
                document.getElementById('result-area').classList.add('hidden');
                return;
            }

            if (source === 'CE') {
                const ceM = ('0' + m).slice(-2);
                const ceD = ('0' + d).slice(-2);
                document.getElementById(id).value = `${y}-${ceM}-${ceD}`;

                document.getElementById(id + '_roc_y').value = y - 1911;
                document.getElementById(id + '_roc_m').value = m;
                document.getElementById(id + '_roc_d').value = d;
            } else {
                const ceY = y + 1911;
                const ceM = ('0' + m).slice(-2);
                const ceD = ('0' + d).slice(-2);
                document.getElementById(id).value = `${ceY}-${ceM}-${ceD}`;

                document.getElementById(id + '_ce_y').value = ceY;
                document.getElementById(id + '_ce_m').value = m;
                document.getElementById(id + '_ce_d').value = d;
            }
        }

        function triggerCalc() {
            if (currentMode === 'calc') runCalc(); 
            else if (currentMode === 'penalty') runPenalty();
        }

        function setType(t) {
            currentType = t;
            document.getElementById('btn-normal').className = t === 'normal' ? BTN_ACTIVE : BTN_INACTIVE;
            document.getElementById('btn-adverse').className = t === 'adverse' ? BTN_ACTIVE : BTN_INACTIVE;
            document.getElementById('type-desc').innerText = t === 'normal' ? "â€» ä¸€èˆ¬æ¡ˆä»¶ï¼šæœ«æ—¥é‡å‡æ—¥é †å»¶ã€‚" : "â€» ä¸åˆ©è™•åˆ†ï¼šå§‹æ—¥è¨ˆå…¥ä¸”ä¸é †å»¶ã€‚";
            runCalc();
        }

        function isHoliday(date) {
            const y = date.getFullYear(), m = date.getMonth(), d = date.getDate();
            if (HOLIDAY_DATA[y] && HOLIDAY_DATA[y][m]) return HOLIDAY_DATA[y][m].charAt(d - 1) === "1";
            return (date.getDay() === 0 || date.getDay() === 6);
        }

        function getLocalDateStr(date) {
            let y = date.getFullYear();
            let m = ('0' + (date.getMonth() + 1)).slice(-2);
            let d = ('0' + date.getDate()).slice(-2);
            if (yearMode === 'ROC') return `${y - 1911}-${m}-${d}`;
            return `${y}-${m}-${d}`;
        }

        function parseDate(str) {
            if (!str) return null;
            const [y, m, d] = str.split('-').map(Number);
            const date = new Date(y, m - 1, d);
            if (date.getFullYear() !== y || date.getMonth() !== m - 1 || date.getDate() !== d) return null;
            return date;
        }

        function getEquivalentDate(start, addedMonths) {
            let y = start.getFullYear() + Math.floor((start.getMonth() + addedMonths) / 12);
            let m = (start.getMonth() + addedMonths) % 12;
            let d = start.getDate();
            let temp = new Date(y, m, d);
            if (temp.getMonth() !== m) temp = new Date(y, m + 1, 0);
            return temp;
        }

        function runCalc() {
            const s = document.getElementById('startDate').value;
            if (!s) return;
            const p = parseInt(document.getElementById('periodValue').value);
            const u = document.getElementById('periodUnit').value;
            if (isNaN(p)) return;

            const start = parseDate(s);
            if (!start) {
                document.getElementById('result-area').classList.add('hidden');
                return;
            }

            let end, detail;

            if (currentType === 'normal') {
                if (u === 'day') {
                    end = new Date(start);
                    end.setDate(end.getDate() + p);
                } else if (u === 'month') {
                    end = getEquivalentDate(start, p);
                } else {
                    end = getEquivalentDate(start, p * 12);
                }
                let skip = 0;
                while (isHoliday(end)) { end.setDate(end.getDate() + 1); skip++; }
                detail = `ä¸€èˆ¬æ¡ˆä»¶ï¼šå§‹æ—¥ä¸è¨ˆã€‚` + (skip > 0 ? ` æœ«æ—¥é€¢å‡æ—¥é †å»¶ ${skip} å¤©ã€‚` : "");
            } else {
                if (u === 'day') {
                    end = new Date(start);
                    end.setDate(end.getDate() + (p - 1));
                } else {
                    end = getEquivalentDate(start, u === 'month' ? p : p * 12);
                    end.setDate(end.getDate() - 1);
                }
                detail = "ä¸åˆ©è™•åˆ†ï¼šå§‹æ—¥è¨ˆå…¥ï¼Œä¸é †å»¶ã€‚";
            }

            const actualStart = new Date(start);
            if (currentType === 'normal') actualStart.setDate(actualStart.getDate() + 1);

            const total = Math.round((end - actualStart) / 864e5) + 1;
            showResult("å±†æ»¿æ—¥æœŸ (æœ«æ—¥)", getLocalDateStr(end), weekNames[end.getDay()], detail, "blue", `å…±è¨ˆ ${total} æ—¥`);
        }

        let penaltyNation = 'china'; 
        let lastTotalDays = 0; 

        function setPenaltyNation(nation) {
            penaltyNation = nation;
            document.getElementById('btn-china').className = nation === 'china' ? BTN_ACTIVE : BTN_INACTIVE;
            document.getElementById('btn-foreign').className = nation === 'foreign' ? BTN_ACTIVE : BTN_INACTIVE;
            updateFineDisplay(lastTotalDays);
        }

        function getFineInfo(totalDays, nation) {
            if (nation === 'china') {
                let amount, basis;
                if (totalDays <= 10) { amount = 2000; basis = 'é€¾æœŸ 10 æ—¥ä»¥ä¸‹'; }
                else if (totalDays <= 30) { amount = 4000; basis = 'é€¾æœŸ 11 æ—¥ä»¥ä¸Šï¼Œ30 æ—¥ä»¥ä¸‹'; }
                else if (totalDays <= 60) { amount = 6000; basis = 'é€¾æœŸ 31 æ—¥ä»¥ä¸Šï¼Œ60 æ—¥ä»¥ä¸‹'; }
                else if (totalDays <= 90) { amount = 8000; basis = 'é€¾æœŸ 61 æ—¥ä»¥ä¸Šï¼Œ90 æ—¥ä»¥ä¸‹'; }
                else { amount = 10000; basis = 'é€¾æœŸ 91 æ—¥ä»¥ä¸Š'; }
                return { amount, basis, currency: 'NT$', note: 'â€» æœªæ»¿14æ­²è€…ä¸ç½°ï¼›14æ­²ä»¥ä¸Šæœªæ»¿18æ­²è€…æ¸›åŠã€‚ä¾ã€Šå…©å²¸æ¢ä¾‹ã€‹è£è™•ã€‚' };
            } else {
                let amount, basis;
                if (totalDays <= 10) { amount = 10000; basis = 'é€¾æœŸ 10 æ—¥ä»¥ä¸‹'; }
                else if (totalDays <= 30) { amount = 20000; basis = 'é€¾æœŸ 11 æ—¥ä»¥ä¸Šï¼Œ30 æ—¥ä»¥ä¸‹'; }
                else if (totalDays <= 60) { amount = 30000; basis = 'é€¾æœŸ 31 æ—¥ä»¥ä¸Šï¼Œ60 æ—¥ä»¥ä¸‹'; }
                else if (totalDays <= 90) { amount = 40000; basis = 'é€¾æœŸ 61 æ—¥ä»¥ä¸Šï¼Œ90 æ—¥ä»¥ä¸‹'; }
                else { amount = 50000; basis = 'é€¾æœŸ 91 æ—¥ä»¥ä¸Š'; }
                return { amount, basis, currency: 'NT$', note: 'â€» ä¾ã€Šå…¥å‡ºåœ‹åŠç§»æ°‘æ³•ã€‹ç¬¬74æ¢ä¹‹1è£è™•ã€‚' };
            }
        }

        function updateFineDisplay(totalDays) {
            const fineBox = document.getElementById('fine-display');
            const nationBox = document.getElementById('nation-switcher');

            if (totalDays <= 0) {
                fineBox.classList.add('hidden');
                nationBox.classList.add('hidden');
                return;
            }

            nationBox.classList.remove('hidden');
            const info = getFineInfo(totalDays, penaltyNation);
            
            document.getElementById('fine-amount').innerText = `${info.currency} ${info.amount.toLocaleString()} å…ƒ`;
            document.getElementById('fine-basis').innerText = `å…± ${totalDays} å¤©ã€€é©ç”¨ç´šè·ï¼š${info.basis}`;
            document.getElementById('fine-note').innerText = info.note;
            
            fineBox.classList.remove('hidden');
        }

        function runPenalty() {
            const v1 = document.getElementById('date-start').value;
            const v2 = document.getElementById('date-end').value;
            
            if (!v1 || !v2) {
                lastTotalDays = 0;
                updateFineDisplay(0);
                return;
            }

            const start = parseDate(v1);
            const end = parseDate(v2);
            
            if (!start || !end) {
                lastTotalDays = 0;
                updateFineDisplay(0);
                return;
            }

            if (start > end) {
                lastTotalDays = 0;
                updateFineDisplay(0);
                return showResult("éŒ¯èª¤", "æ—¥æœŸé †åºæœ‰èª¤", "", "èµ·ç®—æ—¥ä¸å¯æ™šæ–¼å—ç†æ—¥", "rose", "");
            }

            const totalDays = Math.round((end - start) / 864e5) + 1;
            lastTotalDays = totalDays;
            updateFineDisplay(totalDays);

            let totalMonths = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());
            let tempDate = getEquivalentDate(start, totalMonths);
            if (tempDate > end) { totalMonths--; tempDate = getEquivalentDate(start, totalMonths); }

            let years = Math.floor(totalMonths / 12), months = totalMonths % 12;
            let remainDays = Math.round((end - tempDate) / 864e5) + 1;

            let resStr = "";
            if (years > 0) resStr += years + "å¹´";
            if (months > 0) resStr += months + "å€‹æœˆ";
            if (remainDays > 0 || resStr === "") resStr += remainDays + "æ—¥";

            let detailHtml = "";
            if (totalMonths > 0) {
                let endOfPeriod = new Date(tempDate);
                endOfPeriod.setDate(endOfPeriod.getDate() - 1);
                detailHtml += `èµ·ç®—æ—¥ç‚º ${getLocalDateStr(start)}ï¼Œè‡³ç›¸ç•¶æ—¥å‰ä¸€æ—¥ ${getLocalDateStr(endOfPeriod)}ï¼Œè¨ˆ ${years > 0 ? years + 'å¹´' : ''}${months > 0 ? months + 'å€‹æœˆ' : ''}ã€‚\n`;
                if (remainDays > 0) detailHtml += `é¤˜é¡ ${getLocalDateStr(tempDate)} è‡³ ${getLocalDateStr(end)}ï¼Œè¨ˆ ${remainDays} æ—¥ã€‚\n`;
                detailHtml += `å…±è¨ˆ ${totalDays} æ—¥ã€‚`;
            } else {
                detailHtml += `èµ·ç®—æ—¥ç‚º ${getLocalDateStr(start)}ï¼Œè‡³ ${getLocalDateStr(end)}ï¼Œä¸è¶³ 1 å€‹æœˆã€‚\nå…±è¨ˆ ${remainDays} æ—¥ã€‚`;
            }
            
            showResult("è¨ˆç®—çµæœ", resStr, ``, detailHtml, "emerald", "");
        }

        function showResult(t, m, s, d, color, total) {
            document.getElementById('result-area').classList.remove('hidden');
            document.getElementById('res-title').innerText = t;
            document.getElementById('res-main').innerText = m;
            document.getElementById('res-sub').innerText = s;
            document.getElementById('res-detail').innerText = d;

            const tBox = document.getElementById('res-total-days');
            tBox.innerText = total || "";
            tBox.classList.toggle('hidden', !total);
            
            const themes = { 
                blue: "bg-blue-50 text-blue-800 border-blue-100", 
                rose: "bg-rose-50 text-rose-800 border-rose-100", 
                emerald: "bg-emerald-50 text-emerald-800 border-emerald-100" 
            };
            document.getElementById('status-card').className = `p-6 rounded-2xl border ${themes[color]}`;
        }

        // ---- æœˆæ›†é¸å– ----
        function openCalendar(targetPrefix) {
            calTargetPrefix = targetPrefix;
            calIsROC = targetPrefix.endsWith('_roc');

            const inputY = document.getElementById(targetPrefix + '_y').value;
            const inputM = document.getElementById(targetPrefix + '_m').value;

            if (inputY && inputM) {
                calViewYear = parseInt(inputY);
                calViewMonth = parseInt(inputM);
            } else {
                const now = new Date();
                calViewYear = calIsROC ? (now.getFullYear() - 1911) : now.getFullYear();
                calViewMonth = now.getMonth() + 1;
            }

            renderCalendar();
            
            const modal = document.getElementById('calendar-modal');
            const card = document.getElementById('calendar-card');
            modal.classList.remove('hidden');

            card.classList.remove('modal-enter-active');
            void card.offsetWidth; 
            card.classList.add('modal-enter-active');
        }

        function closeCalendar() {
            document.getElementById('calendar-modal').classList.add('hidden');
        }

        function changeCalMonth(delta) {
            calViewMonth += delta;
            if (calViewMonth > 12) { calViewMonth = 1; calViewYear++; }
            if (calViewMonth < 1) { calViewMonth = 12; calViewYear--; }
            renderCalendar();
        }

        function renderCalendar() {
            const ceYear = calIsROC ? calViewYear + 1911 : calViewYear;
            const firstDay = new Date(ceYear, calViewMonth - 1, 1).getDay();
            const daysInMonth = new Date(ceYear, calViewMonth, 0).getDate();

            const titlePrefix = calIsROC ? 'æ°‘åœ‹' : 'è¥¿å…ƒ';
            document.getElementById('cal-title').innerText = `${titlePrefix} ${calViewYear} å¹´ ${calViewMonth} æœˆ`;

            let html = '';
            for (let i = 0; i < firstDay; i++) {
                html += `<div></div>`;
            }

            const selY = parseInt(document.getElementById(calTargetPrefix + '_y').value);
            const selM = parseInt(document.getElementById(calTargetPrefix + '_m').value);
            const selD = parseInt(document.getElementById(calTargetPrefix + '_d').value);

            for (let d = 1; d <= daysInMonth; d++) {
                const isSelected = (selY === calViewYear && selM === calViewMonth && selD === d);
                const bgClass = isSelected ? "bg-blue-600 text-white shadow-md ring-2 ring-blue-600 ring-offset-2" : "hover:bg-blue-50 text-slate-700";
                html += `<div class="cursor-pointer rounded-full flex items-center justify-center aspect-square text-sm font-semibold transition-all ${bgClass}" onclick="selectDate(${calViewYear}, ${calViewMonth}, ${d})">${d}</div>`;
            }
            document.getElementById('cal-days').innerHTML = html;
        }

        function selectDate(y, m, d) {
            document.getElementById(calTargetPrefix + '_y').value = y;
            document.getElementById(calTargetPrefix + '_m').value = m;
            document.getElementById(calTargetPrefix + '_d').value = d;

            const baseId = calTargetPrefix.replace('_roc', '').replace('_ce', '');
            const sourceMode = calIsROC ? 'ROC' : 'CE';

            syncDate(baseId, sourceMode);
            triggerCalc();
            closeCalendar();
        }


        // ---- å°ä¸‰é€šå³æ™‚çœ‹æ¿é‚è¼¯ ----
        let matsuInitialized = false;
        let matsuTimeLeft = 300;
        let matsuTimer = null;

        function initMatsuDashboard() {
            fetchMatsuData();
            matsuTimer = setInterval(() => {
                matsuTimeLeft--;
                const mins = Math.floor(matsuTimeLeft / 60);
                const secs = matsuTimeLeft % 60;
                document.getElementById('matsu-countdown').textContent = `æ›´æ–°å€’æ•¸ï¼š${mins}:${secs.toString().padStart(2, '0')}`;
                
                if (matsuTimeLeft <= 0) {
                    fetchMatsuData();
                }
            }, 1000);
        }

        async function fetchMatsuData() {
            const updateTimeLabel = document.getElementById('matsu-updateTime');
            const resultArea = document.getElementById('matsu-resultArea');
            updateTimeLabel.textContent = 'ç‹€æ…‹ï¼šæ­£åœ¨æ›´æ–°è³‡æ–™...';
            
            try {
                const targetUrl = 'https://port.mtha.gov.tw/MOBWeb/PortVesselList';
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;
                const response = await fetch(proxyUrl);
                
                if (!response.ok) throw new Error('é€£ç·šä¸­æ–·');
                
                const html = await response.text();
                parseMatsuData(html, resultArea);
                
                const now = new Date();
                updateTimeLabel.textContent = `æœ€å¾Œæ›´æ–°ï¼š${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                matsuTimeLeft = 300; // æˆåŠŸå¾Œé‡ç½®5åˆ†é˜å€’æ•¸
            } catch (err) {
                updateTimeLabel.textContent = 'ç‹€æ…‹ï¼šæ›´æ–°å¤±æ•—';
                resultArea.innerHTML = `<div class="p-6 text-center text-rose-500 bg-rose-50 rounded-2xl border border-rose-100 text-sm font-bold">ç„¡æ³•å–å¾—èˆ¹ç­è³‡æ–™ï¼š${err.message}</div>`;
            }
        }

        function parseMatsuData(html, container) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const vesselCards = doc.querySelectorAll('.card');
            
            let foundData = false;
            let finalHtml = '';

            vesselCards.forEach(card => {
                const header = card.querySelector('.card-header');
                if (!header) return;

                const typeText = header.querySelector('h5')?.textContent || '';
                if (!typeText.includes('å°ä¸‰é€š')) return;

                foundData = true;
                const shipName = header.querySelector('h4')?.textContent.trim() || 'æœªçŸ¥èˆ¹å';
                
                let rowsHtml = '';
                const items = card.querySelectorAll('.list-group-item');
                
                for (let i = 1; i < items.length; i++) {
                    const rowDivs = items[i].querySelectorAll('.row');
                    if (rowDivs.length >= 2) {
                        const ports = rowDivs[0].querySelectorAll('.col-6');
                        const times = rowDivs[1].querySelectorAll('.col-6');
                        
                        rowsHtml += `
                            <div class="p-3 border-b border-slate-100 last:border-0 bg-white hover:bg-blue-50/50 transition duration-200">
                                <div class="flex justify-between items-center text-sm mb-1.5">
                                    <span class="font-bold text-slate-700">${ports[0].textContent.trim()}</span>
                                    <span class="text-slate-300 text-xs">â†’</span>
                                    <span class="font-bold text-slate-700">${ports[1].textContent.trim()}</span>
                                </div>
                                <div class="flex justify-between items-center font-mono text-xs font-bold">
                                    <span class="text-blue-600 bg-blue-50 px-2 py-0.5 rounded">${times[0].textContent.trim()}</span>
                                    <span class="text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded">${times[1].textContent.trim()}</span>
                                </div>
                            </div>`;
                    }
                }

                // å¥—ç”¨èˆ‡è¨ˆç®—çµæœå¡ç‰‡ç›¸ä»¿çš„ UI é¢¨æ ¼
                finalHtml += `
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden h-fit">
                        <div class="bg-blue-800 text-white px-5 py-3 flex justify-between items-center">
                            <span class="font-bold tracking-wide">${shipName}</span>
                            <span class="bg-white/20 text-white text-[10px] px-2 py-0.5 rounded border border-white/10 font-medium tracking-widest">å°ä¸‰é€š</span>
                        </div>
                        <div class="divide-y divide-slate-100">
                            ${rowsHtml}
                        </div>
                    </div>`;
            });

            if (!foundData) {
                container.innerHTML = '<div class="text-center py-16 text-slate-400 bg-slate-50 rounded-2xl border border-dashed border-slate-200 font-bold text-sm">ç›®å‰æš«ç„¡ä»Šæ—¥é å ±è³‡æ–™</div>';
            } else {
                container.innerHTML = finalHtml;
            }
        }

        // ---- åˆå§‹åŒ– ----
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('holiday.json');
                if (response.ok) {
                    HOLIDAY_DATA = await response.json();
                }
            } catch (error) {
                console.warn("æœªè¼‰å…¥ holiday.json åœ‹å®šå‡æ—¥æª”æ¡ˆï¼Œå°‡åƒ…åˆ¤æ–·é€±æœ«");
            }

            const today = new Date();
            const y = today.getFullYear();
            const m = today.getMonth() + 1;
            const d = today.getDate();

            dateFieldIDs.forEach(id => {
                document.getElementById(id + '_ce_y').value = y;
                document.getElementById(id + '_ce_m').value = m;
                document.getElementById(id + '_ce_d').value = d;
                syncDate(id, 'CE');
            });

            document.querySelectorAll('.auto-calc-ce, .auto-calc-roc, .auto-penalty-ce, .auto-penalty-roc, .auto-calc').forEach(el => {
                el.addEventListener('input', (e) => {
                    const id = e.target.id;
                    if (id.includes('_ce_') || id.includes('_roc_')) {
                        const baseId = id.replace(/_(ce|roc)_(y|m|d)$/, '');
                        const source = id.includes('_ce_') ? 'CE' : 'ROC';
                        syncDate(baseId, source);
                    }
                    triggerCalc();
                });
            });

            setYearMode('ROC');
        });
    </script>
</body version="4.0">
</html>
